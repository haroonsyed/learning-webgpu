(()=>{"use strict";var e=1e-6,t="undefined"!=typeof Float32Array?Float32Array:Array;function i(){var e=new t(3);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function n(e,i,n){var s=new t(3);return s[0]=e,s[1]=i,s[2]=n,s}function s(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function r(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function o(e,t){var i=t[0],n=t[1],s=t[2],r=i*i+n*n+s*s;return r>0&&(r=1/Math.sqrt(r)),e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e}function a(e,t,i){var n=t[0],s=t[1],r=t[2],o=i[3]*n+i[7]*s+i[11]*r+i[15];return o=o||1,e[0]=(i[0]*n+i[4]*s+i[8]*r+i[12])/o,e[1]=(i[1]*n+i[5]*s+i[9]*r+i[13])/o,e[2]=(i[2]*n+i[6]*s+i[10]*r+i[14])/o,e}function u(){var e=new t(16);return t!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function c(e,t,i){var n,s,r,o,a,u,c,h,l,d,_,p,f=i[0],v=i[1],m=i[2];return t===e?(e[12]=t[0]*f+t[4]*v+t[8]*m+t[12],e[13]=t[1]*f+t[5]*v+t[9]*m+t[13],e[14]=t[2]*f+t[6]*v+t[10]*m+t[14],e[15]=t[3]*f+t[7]*v+t[11]*m+t[15]):(n=t[0],s=t[1],r=t[2],o=t[3],a=t[4],u=t[5],c=t[6],h=t[7],l=t[8],d=t[9],_=t[10],p=t[11],e[0]=n,e[1]=s,e[2]=r,e[3]=o,e[4]=a,e[5]=u,e[6]=c,e[7]=h,e[8]=l,e[9]=d,e[10]=_,e[11]=p,e[12]=n*f+a*v+l*m+t[12],e[13]=s*f+u*v+d*m+t[13],e[14]=r*f+c*v+_*m+t[14],e[15]=o*f+h*v+p*m+t[15]),e}function h(t,i,n,s){var r,o,a,u,c,h,l,d,_,p,f,v,m,g,y,E,w,x,b,T,P,R,S,k,A=s[0],N=s[1],O=s[2],M=Math.hypot(A,N,O);return M<e?null:(A*=M=1/M,N*=M,O*=M,r=Math.sin(n),a=1-(o=Math.cos(n)),u=i[0],c=i[1],h=i[2],l=i[3],d=i[4],_=i[5],p=i[6],f=i[7],v=i[8],m=i[9],g=i[10],y=i[11],E=A*A*a+o,w=N*A*a+O*r,x=O*A*a-N*r,b=A*N*a-O*r,T=N*N*a+o,P=O*N*a+A*r,R=A*O*a+N*r,S=N*O*a-A*r,k=O*O*a+o,t[0]=u*E+d*w+v*x,t[1]=c*E+_*w+m*x,t[2]=h*E+p*w+g*x,t[3]=l*E+f*w+y*x,t[4]=u*b+d*T+v*P,t[5]=c*b+_*T+m*P,t[6]=h*b+p*T+g*P,t[7]=l*b+f*T+y*P,t[8]=u*R+d*S+v*k,t[9]=c*R+_*S+m*k,t[10]=h*R+p*S+g*k,t[11]=l*R+f*S+y*k,i!==t&&(t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t)}function l(e,t,i){var n=Math.sin(i),s=Math.cos(i),r=t[0],o=t[1],a=t[2],u=t[3],c=t[8],h=t[9],l=t[10],d=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s-c*n,e[1]=o*s-h*n,e[2]=a*s-l*n,e[3]=u*s-d*n,e[8]=r*n+c*s,e[9]=o*n+h*s,e[10]=a*n+l*s,e[11]=u*n+d*s,e}Math.random,Math.PI,Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)}),i();function d(){var e=new t(4);return t!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function _(e,i,n,s){var r=new t(4);return r[0]=e,r[1]=i,r[2]=n,r[3]=s,r}d();const p=(e,t=GPUBufferUsage.VERTEX|GPUBufferUsage.COPY_DST)=>{const{device:i}=I,n=i.createBuffer({size:e.byteLength,usage:t,mappedAtCreation:!0}),s=n.getMappedRange();return new Uint8Array(s).set(new Uint8Array(e.buffer,e.byteOffset,e.byteLength)),n.unmap(),n};const f={};var v=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};class m{constructor({id:e,name:t,scene:s,model:r="",shader_path:o="",pipeline:a,position:h=i(),velocity:m=i(),rotation:g=i(),scale:y=n(1,1,1),texture_diffuse:E,texture_specular:w,texture_normal:x,texture_emissive:b}){this.get_model_matrix=()=>{const e=u();var t,i,n,s,r,o,a,h,d,_,p,f,v;return c(e,e,this.position),t=e,i=e,n=this.rotation[0],s=Math.sin(n),r=Math.cos(n),o=i[4],a=i[5],h=i[6],d=i[7],_=i[8],p=i[9],f=i[10],v=i[11],i!==t&&(t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15]),t[4]=o*r+_*s,t[5]=a*r+p*s,t[6]=h*r+f*s,t[7]=d*r+v*s,t[8]=_*r-o*s,t[9]=p*r-a*s,t[10]=f*r-h*s,t[11]=v*r-d*s,l(e,e,this.rotation[1]),function(e,t,i){var n=Math.sin(i),s=Math.cos(i),r=t[0],o=t[1],a=t[2],u=t[3],c=t[4],h=t[5],l=t[6],d=t[7];t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=r*s+c*n,e[1]=o*s+h*n,e[2]=a*s+l*n,e[3]=u*s+d*n,e[4]=c*s-r*n,e[5]=h*s-o*n,e[6]=l*s-a*n,e[7]=d*s-u*n}(e,e,this.rotation[2]),function(e,t,i){var n=i[0],s=i[1],r=i[2];e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n,e[3]=t[3]*n,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*r,e[9]=t[9]*r,e[10]=t[10]*r,e[11]=t[11]*r,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]}(e,e,this.scale),e},this.get_model_data=()=>v(this,void 0,void 0,(function*(){var e,t,i,n,s;return yield(e=this.model,t=void 0,i=void 0,n=void 0,s=function*(){if(!e)return;if(f[e])return;console.log("Loading model",e);const t=yield fetch(e),i=yield t.text(),n=[],s=[],r=[],o=[];let a=d(),u=d();i.split("\n").forEach((e=>{const t=e.split(" "),i=t[0];if("v"===i){const e=_(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),1);a[0]=Math.max(a[0],e[0]),a[1]=Math.max(a[1],e[1]),a[2]=Math.max(a[2],e[2]),u[0]=Math.min(u[0],e[0]),u[1]=Math.min(u[1],e[1]),u[2]=Math.min(u[2],e[2]),n.push(e)}else if("vn"===i){const e=_(parseFloat(t[1]),parseFloat(t[2]),parseFloat(t[3]),0);s.push(e)}else if("vt"===i){const e=_(parseFloat(t[1]),parseFloat(t[2]),0,0);r.push(e)}else"f"===i&&(o.push(t[1]),o.push(t[2]),o.push(t[3]))})),u[0],a[0],u[0],u[1],a[1],u[1],u[2],a[2],u[2];const c=[],h=new Map;let l=[];o.forEach((e=>{if(!h.has(e)){const t=e.split("/").filter((e=>""!==e)),i=parseInt(t[0])-1,o=parseInt(t[1])-1,a=parseInt(t[2])-1;l.push(n[i]),l.push(r[o]||d()),l.push(s[a]||d());const u=h.size;h.set(e,u)}c.push(h.get(e))}));const v=l.flatMap((e=>[...e])),m={vertex_data_gpu:p(new Float32Array(v)),indices_gpu:p(new Int32Array(c),GPUBufferUsage.INDEX|GPUBufferUsage.COPY_DST),index_count:c.length};f[e]=m},new(n||(n=Promise))((function(e,r){function o(e){try{u(s.next(e))}catch(e){r(e)}}function a(e){try{u(s.throw(e))}catch(e){r(e)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}u((s=s.apply(t,i||[])).next())}))),f[this.model]})),this.has_texture_diffuse=()=>void 0!==this.texture_diffuse&&""!==this.texture_diffuse,this.has_texture_specular=()=>void 0!==this.texture_specular&&""!==this.texture_specular,this.has_texture_normal=()=>void 0!==this.texture_normal&&""!==this.texture_normal,this.has_texture_emissive=()=>void 0!==this.texture_emissive&&""!==this.texture_emissive,this.update=e=>v(this,void 0,void 0,(function*(){})),this.remove_from_scene=e=>{e.objects=e.objects.filter((e=>e!==this))},this.id=e,this.name=t,this.position=h,this.velocity=m,this.rotation=g,this.scale=y,this.model=r,this.texture_diffuse=E,this.texture_specular=w,this.texture_normal=x,this.texture_emissive=b,this.shader_path=o,this.pipeline=a,this.pipeline_key=(null==a?void 0:a.get_pipeline_key(o))||""}}var g;!function(e){e[e.ROTATE_ORIGIN=0]="ROTATE_ORIGIN",e[e.FREE=1]="FREE",e[e.FIXED=2]="FIXED"}(g||(g={}));class y extends m{constructor(t){var{look_at_target:d}=t;super(function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i}(t,["look_at_target"])),this.up=n(0,1,0),this.look_at_target=i(),this.movement_mode=g.ROTATE_ORIGIN,this.rotation_speed=.01,this.movement_speed=.01,this.mouse_sensitivity=.001,this.look_at=e=>{this.look_at_target=e},this.get_camera_forward=()=>{return o(i(),(e=i(),t=this.look_at_target,n=this.position,e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e));var e,t,n},this.get_camera_right=()=>{return o(i(),(e=i(),t=this.get_camera_forward(),n=this.up,s=t[0],r=t[1],a=t[2],u=n[0],c=n[1],h=n[2],e[0]=r*h-a*c,e[1]=a*u-s*h,e[2]=s*c-r*u,e));var e,t,n,s,r,a,u,c,h},this.get_view_matrix=()=>{const t=u();return c(t,t,this.position),i=t,n=this.position,s=this.look_at_target,r=this.up,g=n[0],y=n[1],E=n[2],w=r[0],x=r[1],b=r[2],T=s[0],P=s[1],R=s[2],Math.abs(g-T)<e&&Math.abs(y-P)<e&&Math.abs(E-R)<e?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(i):(p=g-T,f=y-P,v=E-R,o=x*(v*=m=1/Math.hypot(p,f,v))-b*(f*=m),a=b*(p*=m)-w*v,h=w*f-x*p,(m=Math.hypot(o,a,h))?(o*=m=1/m,a*=m,h*=m):(o=0,a=0,h=0),l=f*h-v*a,d=v*o-p*h,_=p*a-f*o,(m=Math.hypot(l,d,_))?(l*=m=1/m,d*=m,_*=m):(l=0,d=0,_=0),i[0]=o,i[1]=l,i[2]=p,i[3]=0,i[4]=a,i[5]=d,i[6]=f,i[7]=0,i[8]=h,i[9]=_,i[10]=v,i[11]=0,i[12]=-(o*g+a*y+h*E),i[13]=-(l*g+d*y+_*E),i[14]=-(p*g+f*y+v*E),i[15]=1),t;var i,n,s,r,o,a,h,l,d,_,p,f,v,m,g,y,E,w,x,b,T,P,R},this.get_projection_matrix=e=>{e||(e=window.innerWidth/window.innerHeight);const t=u();return function(e,t,i,n,s){var r,o=1/Math.tan(t/2);e[0]=o/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=o,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=s&&s!==1/0?(r=1/(n-s),e[10]=(s+n)*r,e[14]=2*s*n*r):(e[10]=-1,e[14]=-2*n)}(t,Math.PI/4,e,.1,1e3),t},this.update=e=>{return t=this,n=void 0,d=function*(){const{key_press:t,key_state:n,mouse_state:o}=I.system_input,{canvas:d}=e;if(t.get("`")&&(console.log("toggling camera mode"),this.movement_mode===g.ROTATE_ORIGIN?(this.movement_mode=g.FREE,null==d||d.requestPointerLock()):this.movement_mode===g.FREE?(document.exitPointerLock(),this.movement_mode=g.FIXED):this.movement_mode===g.FIXED&&(this.movement_mode=g.ROTATE_ORIGIN)),this.movement_mode===g.ROTATE_ORIGIN){if(n.get("a")||n.get("d")){const e=n.get("a")?this.rotation_speed:-this.rotation_speed,t=u();c(t,t,this.look_at_target),l(t,t,e),c(t,t,(_=i(),p=this.look_at_target,_[0]=-p[0],_[1]=-p[1],_[2]=-p[2],_)),a(this.position,this.position,t)}}else if(this.movement_mode===g.FREE){if(o.dx||o.dy){this.get_camera_forward();const e=this.get_camera_right(),t=o.dx*this.mouse_sensitivity,i=o.dy*this.mouse_sensitivity,n=u();h(n,n,-t,this.up),h(n,n,-i,e),a(this.position,this.position,n);const r=this.get_camera_forward();this.get_camera_right(),s(this.look_at_target,this.position,r)}if(n.get("w")||n.get("s")){const e=n.get("w")?this.movement_speed:-this.movement_speed,t=this.get_camera_forward();r(t,t,e),s(this.position,this.position,t),s(this.look_at_target,this.look_at_target,t)}if(n.get("a")||n.get("d")){const e=n.get("a")?-this.movement_speed:this.movement_speed,t=this.get_camera_right();r(t,t,e),s(this.position,this.position,t),s(this.look_at_target,this.look_at_target,t)}}else this.movement_mode,g.FIXED;var _,p},new((o=void 0)||(o=Promise))((function(e,i){function s(e){try{a(d.next(e))}catch(e){i(e)}}function r(e){try{a(d.throw(e))}catch(e){i(e)}}function a(t){var i;t.done?e(t.value):(i=t.value,i instanceof o?i:new o((function(e){e(i)}))).then(s,r)}a((d=d.apply(t,n||[])).next())}));var t,n,o,d},this.look_at(d||i())}}class E extends m{constructor(e){var{color:t=n(1,1,1),intensity:i=1}=e;super(function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i}(e,["color","intensity"])),this.get_uniform_data=()=>({position:[...this.position,0],color:this.color}),this.color=_(t[0],t[1],t[2],i)}}class w{constructor(){this.registered_pipelines=new Map,this.register_pipeline=(e,t,i)=>{const n=e.get_pipeline_key(t);this.registered_pipelines.has(n)||e.construct_pipeline(t,i).then((e=>{this.registered_pipelines.set(n,e)}))},this.get_registered_pipeline=e=>this.registered_pipelines.get(e)}}var x;class b{constructor(){this.shaders=new Map,this.get_shader=e=>{return t=this,i=void 0,s=function*(){if(!this.shaders.has(e)){const t=yield fetch(e);this.shaders.set(e,yield t.text())}return this.shaders.get(e)},new((n=void 0)||(n=Promise))((function(e,r){function o(e){try{u(s.next(e))}catch(e){r(e)}}function a(e){try{u(s.throw(e))}catch(e){r(e)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}u((s=s.apply(t,i||[])).next())}));var t,i,n,s},this.get_registered_shader=e=>this.shaders.get(e)}}!function(e){e[e.SCENE_FRAME_START=0]="SCENE_FRAME_START",e[e.SCENE_FRAME_END=1]="SCENE_FRAME_END",e[e.SCENE_UPDATE_START=2]="SCENE_UPDATE_START",e[e.SCENE_UPDATE_END=3]="SCENE_UPDATE_END",e[e.SCENE_RENDER_START=4]="SCENE_RENDER_START",e[e.SCENE_RENDER_END=5]="SCENE_RENDER_END"}(x||(x={}));class T{constructor(){this.events=new Map}subscribe(e,t){return this.events.has(e)||this.events.set(e,[]),this.events.get(e).includes(t)||this.events.get(e).push(t),t}unsubscribe(e,t){var i;const n=this.events.get(e),s=null!==(i=null==n?void 0:n.indexOf(t))&&void 0!==i?i:-1;s>=0&&n.splice(s,1)}publish(e){return t=this,i=arguments,s=function*(e,t={}){if(!this.events.has(e))return;const i=this.events.get(e).map((e=>e(t)));yield Promise.all(i)},new((n=void 0)||(n=Promise))((function(e,r){function o(e){try{u(s.next(e))}catch(e){r(e)}}function a(e){try{u(s.throw(e))}catch(e){r(e)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}u((s=s.apply(t,i||[])).next())}));var t,i,n,s}}class P{constructor(){this.textures={},this.empty_texture=this.get_default_texture()}get_default_texture(){return I.device.createTexture({size:[1,1],format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST})}load_texture(e){return t=this,i=arguments,s=function*(e,t="rgba8unorm"){if(void 0===e||""===e)return this.empty_texture;if(this.textures[e])return this.textures[e];const i=yield fetch(e),n=yield i.blob(),s=yield createImageBitmap(n,{colorSpaceConversion:"none"}),r=I.device.createTexture({label:e,format:t,size:[s.width,s.height],usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT});return I.device.queue.copyExternalImageToTexture({source:s},{texture:r},[s.width,s.height]),this.textures[e]=r,r},new((n=void 0)||(n=Promise))((function(e,r){function o(e){try{u(s.next(e))}catch(e){r(e)}}function a(e){try{u(s.throw(e))}catch(e){r(e)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof n?i:new n((function(e){e(i)}))).then(o,a)}u((s=s.apply(t,i||[])).next())}));var t,i,n,s}}const R={SceneObject:m,Light:E,Camera:y,ComputeObject:class extends m{constructor(e){var t,i;super(e),this.parse_workgroup_size=(e,t,i)=>{if("string"!=typeof e)return e;switch(e){case"canvas_width":return t;case"canvas_height":return i;default:return 1}};const n=(null===(t=e.scene.canvas)||void 0===t?void 0:t.width)||1,s=(null===(i=e.scene.canvas)||void 0===i?void 0:i.height)||1;this.workgroup_size=[this.parse_workgroup_size(e.workgroup_size[0],n,s),this.parse_workgroup_size(e.workgroup_size[1],n,s),this.parse_workgroup_size(e.workgroup_size[2],n,s)]}}};class S{constructor(e,t,i=0){this.shader_path=e,this.order=i,this.gpu_pipeline=t}static get_pipeline_key(e){return`${e}+${this.get_pipeline_label()}`}static get_pipeline_label(){throw new Error("Please return a unique label for your pipeline from get_pipeline_label")}static construct_pipeline(e,t){return i=this,n=void 0,r=function*(){throw new Error("Please implement logic for creating your pipeline, make sure to call super() so the pipeline is registered.")},new((s=void 0)||(s=Promise))((function(e,t){function o(e){try{u(r.next(e))}catch(e){t(e)}}function a(e){try{u(r.throw(e))}catch(e){t(e)}}function u(t){var i;t.done?e(t.value):(i=t.value,i instanceof s?i:new s((function(e){e(i)}))).then(o,a)}u((r=r.apply(i,n||[])).next())}));var i,n,s,r}}var k=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};class A extends S{static get_pipeline_label(){return"default_2d_compute"}static construct_pipeline(e,t){return k(this,void 0,void 0,(function*(){const i=yield t.shader_manager.get_shader(e),{device:n}=I,s=n.createShaderModule({code:i}),r=n.createComputePipeline({layout:"auto",compute:{module:s,entryPoint:"main"}});return new A(e,r)}))}render(e){return k(this,void 0,void 0,(function*(){const t=A.get_pipeline_key(this.shader_path),i=e.objects.filter((e=>e.pipeline_key===t));if(0===i.length||!e.texture_view)return;const n=I.command_encoder.beginComputePass();n.setPipeline(this.gpu_pipeline);const s={layout:this.gpu_pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:e.texture_view}]};n.setBindGroup(0,I.device.createBindGroup(s)),i.forEach((e=>{const t=e;n.dispatchWorkgroups(t.workgroup_size[0],t.workgroup_size[1],t.workgroup_size[2])})),n.end()}))}}var N=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};const O={entries:[{binding:0,visibility:GPUShaderStage.VERTEX|GPUShaderStage.FRAGMENT,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.FRAGMENT,sampler:{}},{binding:2,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:3,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:4,visibility:GPUShaderStage.FRAGMENT,texture:{}},{binding:5,visibility:GPUShaderStage.VERTEX,buffer:{type:"read-only-storage"}}]};class M extends S{static get_pipeline_label(){return"default_3d"}static construct_pipeline(e,t){return N(this,void 0,void 0,(function*(){const{shader_manager:i}=t,n=yield i.get_shader(e),{device:s}=I,{presentation_format:r}=t,o=s.createShaderModule({code:n}),a=s.createBindGroupLayout(O),u=s.createRenderPipeline({label:"default_3d",layout:s.createPipelineLayout({bindGroupLayouts:[a]}),vertex:{module:o,buffers:[{arrayStride:48,attributes:[{shaderLocation:0,offset:0,format:"float32x4"},{shaderLocation:1,offset:16,format:"float32x4"},{shaderLocation:2,offset:32,format:"float32x4"}]}]},fragment:{module:o,targets:[{format:r}]},primitive:{topology:"triangle-list"},depthStencil:{format:"depth24plus",depthWriteEnabled:!0,depthCompare:"less"}}),c=new M(e,u);return c.uniform_buffer=p(new Float32Array(116),GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST),c}))}render(e){return N(this,void 0,void 0,(function*(){var t,i,n;const{device:s,command_encoder:r}=I,{texture_manager:o,texture_view:a,depth_texture_view:u}=e,c=M.get_pipeline_key(this.shader_path),h=e.objects.filter((e=>e.pipeline_key===c));if(0===h.length||!a||!u)return;const l=r.beginRenderPass({colorAttachments:[{view:a,clearValue:[0,0,0,1],loadOp:"clear",storeOp:"store"}],depthStencilAttachment:{view:u,depthClearValue:1,stencilClearValue:0,depthLoadOp:"clear",depthStoreOp:"store"}});l.setPipeline(this.gpu_pipeline);const d=h[0],_=d.has_texture_diffuse()?1:0,f=d.has_texture_specular()?1:0,v=d.has_texture_normal()?1:0,m=yield o.load_texture(d.texture_diffuse),g=yield o.load_texture(d.texture_specular),y=yield o.load_texture(d.texture_normal),E=new Float32Array(h.flatMap((e=>[...e.get_model_matrix()])));16*h.length*4>(null!==(i=null===(t=this.model_transforms)||void 0===t?void 0:t.size)&&void 0!==i?i:0)?(null===(n=this.model_transforms)||void 0===n||n.destroy(),this.model_transforms=p(E,GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST)):s.queue.writeBuffer(this.model_transforms,0,E);const w=new Float32Array([_,f,v,e.lights.length,...e.camera.get_view_matrix(),...e.camera.get_projection_matrix(),...e.lights.reduce(((e,t)=>e.concat([...t.position,0,...t.color])),[])]);s.queue.writeBuffer(this.uniform_buffer,0,w);const x={layout:this.gpu_pipeline.getBindGroupLayout(0),entries:[{binding:0,resource:{buffer:this.uniform_buffer,offset:0,size:this.uniform_buffer.size}},{binding:1,resource:s.createSampler({})},{binding:2,resource:m.createView()},{binding:3,resource:g.createView()},{binding:4,resource:y.createView()},{binding:5,resource:{buffer:this.model_transforms,offset:0,size:this.model_transforms.size}}]};l.setBindGroup(0,s.createBindGroup(x));const{vertex_data_gpu:b,indices_gpu:T,index_count:P}=yield d.get_model_data();l.setVertexBuffer(0,b),l.setIndexBuffer(T,"uint32"),l.drawIndexed(P,h.length,0,0,0),l.end()}))}}const U={Default2DComputePipeLine:A,Default3DPipeLine:M};var G=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};class D{constructor(e="",t="canvas"){this.active=!0,this.current_frame=0,this.event_system=new T,this.texture_manager=new P,this.pipeline_manager=new w,this.shader_manager=new b,this.presentation_format="rgba8unorm",this.lights=[],this.camera=new y({id:"-1",name:"camera",scene:this}),this.objects=[],this.load_scene=(e,t)=>G(this,void 0,void 0,(function*(){console.log(`Loading scene from: ${e}`);try{const i=yield fetch(e),n=yield i.json(),s=n.canvas||"canvas";if(this.canvas=document.getElementById(s),this.resize_scene(),!this.canvas)throw alert("Canvas not found"),new Error("Canvas not found");const r=this.canvas.getContext("webgpu");if(!r)throw alert("WebGPU not supported"),new Error("WebGPU not supported");r.configure({device:I.device,format:this.presentation_format,usage:GPUTextureUsage.RENDER_ATTACHMENT|GPUTextureUsage.STORAGE_BINDING}),n.objects.forEach((e=>{const{type:i,pipeline:n}=e,s=function(e,t){var i={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(i[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var s=0;for(n=Object.getOwnPropertySymbols(e);s<n.length;s++)t.indexOf(n[s])<0&&Object.prototype.propertyIsEnumerable.call(e,n[s])&&(i[n[s]]=e[n[s]])}return i}(e,["type","pipeline"]),r=R[i];if(r){const e=new r(Object.assign(Object.assign({},s),{scene:this,pipeline:n&&U[n]}));e instanceof y?t.camera=e:e instanceof E?t.add_light(e):t.add_object(e)}else console.error(`Unrecognized object type: ${i}, did you add it to the registered types file?`)}))}catch(e){console.error(`Error loading scene: ${e}`)}})),this.resize_scene=()=>{var e;const t=null===(e=this.canvas)||void 0===e?void 0:e.getBoundingClientRect();this.canvas&&t&&(this.canvas.width=t.width,this.canvas.height=t.height,this.depth_texture_view=I.device.createTexture({label:"Depth Texture",size:{width:this.canvas.width,height:this.canvas.height,depthOrArrayLayers:1},format:"depth24plus",usage:GPUTextureUsage.RENDER_ATTACHMENT}).createView())},this.add_light=e=>{this.lights.push(e)},this.add_object=e=>{this.objects.push(e),e.pipeline&&this.pipeline_manager.register_pipeline(e.pipeline,e.shader_path,this)},this.frame_start=()=>G(this,void 0,void 0,(function*(){var e;if(!this.active)return;const t=null===(e=this.canvas)||void 0===e?void 0:e.getContext("webgpu");t&&(this.texture_view=t.getCurrentTexture().createView(),yield this.event_system.publish(x.SCENE_FRAME_START))})),this.frame_end=()=>G(this,void 0,void 0,(function*(){this.current_frame++,yield this.event_system.publish(x.SCENE_FRAME_END)})),this.update=()=>G(this,void 0,void 0,(function*(){if(I.system_input.key_press.get("q")||!this.active)return this.active=!1,void console.log("Ending scene...");yield this.event_system.publish(x.SCENE_UPDATE_START);const e=[...this.objects,...this.lights,this.camera].map((e=>e.update(this)));yield Promise.all(e),yield this.event_system.publish(x.SCENE_UPDATE_END)})),this.render=()=>G(this,void 0,void 0,(function*(){yield this.event_system.publish(x.SCENE_RENDER_START);const e=Array.from(this.pipeline_manager.registered_pipelines.values()).reduce(((e,t)=>{const i=t.order;return e.has(i)||e.set(i,[]),e.get(i).push(t),e}),new Map),t=Array.from(e.keys()).sort();for(const i of t){const t=e.get(i).map((e=>e.render(this)));yield Promise.all(t)}yield this.event_system.publish(x.SCENE_RENDER_END)})),this.load_scene(e,this).then((()=>{window.addEventListener("resize",this.resize_scene),this.event_system.subscribe(x.SCENE_FRAME_START,this.update),this.event_system.subscribe(x.SCENE_UPDATE_END,this.render),this.event_system.subscribe(x.SCENE_RENDER_END,this.frame_end)}))}}class C{constructor(){this.key_state=new Map,this.key_press=new Map,this.mouse_state={x:0,y:0,dx:0,dy:0,left:!1,right:!1,middle:!1,left_click:!1,right_click:!1,middle_click:!1},window.addEventListener("keydown",(e=>{this.key_state.set(e.key,!0)})),window.addEventListener("keyup",(e=>{this.key_state.set(e.key,!1)})),window.addEventListener("keypress",(e=>{this.key_press.set(e.key,!0)})),window.addEventListener("mousemove",(e=>{this.mouse_state.dx=e.movementX,this.mouse_state.dy=e.movementY,this.mouse_state.x=e.x,this.mouse_state.y=e.y})),window.addEventListener("mousedown",(e=>{0===e.button?this.mouse_state.left=!0:1===e.button?this.mouse_state.middle=!0:2===e.button&&(this.mouse_state.right=!0)})),window.addEventListener("mouseup",(e=>{0===e.button?this.mouse_state.left=!1:1===e.button?this.mouse_state.middle=!1:2===e.button&&(this.mouse_state.right=!1)})),window.addEventListener("click",(e=>{0===e.button?this.mouse_state.left_click=!0:1===e.button?this.mouse_state.middle_click=!0:2===e.button&&(this.mouse_state.right_click=!0)}))}reset(){this.key_state.clear(),this.key_press.clear(),this.mouse_state={x:0,y:0,dx:0,dy:0,left:!1,right:!1,middle:!1,left_click:!1,right_click:!1,middle_click:!1}}}var F=function(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{u(n.next(e))}catch(e){r(e)}}function a(e){try{u(n.throw(e))}catch(e){r(e)}}function u(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}u((n=n.apply(e,t||[])).next())}))};class I{static start(){return F(this,void 0,void 0,(function*(){yield I.init_webgpu(),I.config=yield(yield fetch("./system_core_config.json")).json(),I.system_input=new C,I.scenes.push(new D(I.config.start_scene)),console.log("SystemCore initialized, starting event loop..."),I.event_loop()}))}static init_webgpu(){return F(this,void 0,void 0,(function*(){var e;const t=yield null===(e=navigator.gpu)||void 0===e?void 0:e.requestAdapter(),i=yield null==t?void 0:t.requestDevice();if(!t||!i)throw alert("WebGPU not supported"),new Error("WebGPU not supported");I.adapter=t,I.device=i}))}static event_loop(){return F(this,void 0,void 0,(function*(){I.command_encoder=I.device.createCommandEncoder(),yield Promise.all(this.scenes.map((e=>e.frame_start()))),I.device.queue.submit([I.command_encoder.finish()]),requestAnimationFrame((()=>I.event_loop())),this.system_input.reset()}))}}I.scenes=[]})();